#!/bin/bash
# =============================================================================
# SteamMachine-DIY - SDDM State Helper (set-sddm-session)
# =============================================================================
# Version: 2.3.0
# Description: Privileged helper with ANSI styling and atomic operations.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/set-sddm-session
# License: MIT
# =============================================================================

set -eou pipefail

# --- ANSI Colors (High Intensity for Root) ---
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
BOLD='\033[1m'
NC='\033[0m'

# --- Configuration ---
readonly SDDM_CONF_DIR="/etc/sddm.conf.d"
readonly SDDM_CONF_FILE="${SDDM_CONF_DIR}/zz-steamos-autologin.conf"
readonly LOG_FILE="/tmp/steamos-diy.log"
readonly RESTART_DELAY="2s"

# Input Arguments
readonly SESSION_NAME=$(basename "${1:-steamos-switcher}" .desktop)
readonly USER_NAME="${2:-}"

# --- Logging System ---
log_helper() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local color=$NC

    case "$level" in
        "INFO")    color=$CYAN ;;
        "SUCCESS") color=$GREEN ;;
        "ERROR")   color=$RED ;;
    esac

    local log_entry="[$timestamp] [HELPER-$level] $message"

    # Terminal Output (Bold for emphasis)
    echo -e "${MAGENTA}${BOLD}[HELPER]${NC} ${color}${message}${NC}"

    # Clean File Output
    echo "$log_entry" >> "$LOG_FILE" 2>/dev/null || true
    logger -t SteamMachine-DIY "$log_entry"
}

# --- Validation ---
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}${BOLD}CRITICAL ERROR:${NC} This script must be run as root (via sudo)"
    exit 1
fi

if [[ -z "$USER_NAME" ]]; then
    log_helper "ERROR" "Execution failed: No target username provided."
    exit 1
fi

# --- Atomic Configuration Write ---
log_helper "INFO" "Applying SDDM State -> User: $USER_NAME | Session: $SESSION_NAME"

mkdir -p "$SDDM_CONF_DIR"

# Creazione file temporaneo
TMP_FILE=$(mktemp)
cat <<EOF > "$TMP_FILE"
[Autologin]
User=$USER_NAME
Session=$SESSION_NAME
Relogin=false
EOF

# Spostamento atomico
if mv "$TMP_FILE" "$SDDM_CONF_FILE"; then
    chmod 644 "$SDDM_CONF_FILE"
    log_helper "SUCCESS" "SDDM Configuration successfully updated."
else
    rm -f "$TMP_FILE"
    log_helper "ERROR" "Failed to move configuration file."
    exit 1
fi

# --- Hardware Reset (Intel UHD 620 Fix) ---
log_helper "INFO" "Intel GPU Reset: Scheduling SDDM restart in ${YELLOW}$RESTART_DELAY${NC}..."

# Esecuzione asincrona via systemd-run
systemd-run --description="SteamMachine-DIY SDDM Restart" \
            --on-active="$RESTART_DELAY" \
            /usr/bin/systemctl restart sddm

echo -e "${MAGENTA}${BOLD}==================================================${NC}"
