#!/bin/bash
# =============================================================================
# SteamMachine-DIY - SDDM State Helper (set-sddm-session)
# =============================================================================
# Version: 2.3.0
# Description: Privileged helper with ANSI styling and atomic operations.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/set-sddm-session
# License: MIT
# =============================================================================

set -eou pipefail

# --- Configuration ---
readonly LOG_FILE="/tmp/steamos-diy.log"
readonly SDDM_CONF="/etc/sddm.conf.d/zz-steamos-autologin.conf"

# Inputs
readonly SESSION_NAME=$(basename "${1:-steamos-switcher}" .desktop)
readonly USER_NAME="${2:-}"

# --- UI Styling (Aligned with os-session-select) ---
BOLD='\033[1m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

# --- Functions ---
log_info() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${CYAN}${BOLD}[INFO]${NC} $1"
    echo "[$timestamp] [HELPER] $1" >> "$LOG_FILE" 2>/dev/null || true
}

log_error() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${RED}${BOLD}[ERROR]${NC} $1" >&2
    echo "[$timestamp] [HELPER_ERROR] $1" >> "$LOG_FILE" 2>/dev/null || true
}

# --- Validation ---
if [[ $EUID -ne 0 ]]; then
    log_error "This helper must be run as root (via sudo)."
    exit 1
fi

# --- Logic ---
if [[ -n "$USER_NAME" ]]; then
    log_info "Updating SDDM autologin: User=${GREEN}$USER_NAME${NC}, Session=${GREEN}$SESSION_NAME${NC}"
    
    # Atomic configuration write
    mkdir -p "$(dirname "$SDDM_CONF")"
    cat <<EOF > "$SDDM_CONF"
[Autologin]
User=$USER_NAME
Session=$SESSION_NAME
Relogin=false
EOF
    chmod 644 "$SDDM_CONF"
else
    log_info "${RED}No username provided.${NC} Clearing autologin configuration..."
    rm -f "$SDDM_CONF"
fi

# --- Execution ---
log_info "Scheduling SDDM restart in 1 second..."

# Detach the restart from the current process to prevent graphical deadlocks.
systemd-run --description="SteamMachine-DIY SDDM Restart" \
            --on-active=1 \
            /usr/bin/systemctl restart sddm
