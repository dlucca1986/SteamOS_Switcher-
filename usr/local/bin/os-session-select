#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Session Manager (os-session-select)
# =============================================================================
# Version: 2.3.0
# Description: Professional session switcher with ANSI styling.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/os-session-select
# License: MIT
# =============================================================================

set -eou pipefail

# --- ANSI Colors (Bold & Vibrant) ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# --- Configuration ---
readonly HELPER_PATH="/usr/local/bin/set-sddm-session"
readonly LOG_FILE="/tmp/steamos-diy.log"
readonly TARGET_MODE="${1,,}"

# --- User Identification ---
if [[ -v SUDO_USER ]]; then
    readonly CURRENT_USER="$SUDO_USER"
else
    readonly CURRENT_USER=$(id -u -n)
fi

# --- Logging System (Dual-Channel) ---
log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local color=$NC

    case "$level" in
        "INFO")    color=$CYAN ;;
        "EXEC")    color=$YELLOW ;;
        "SUCCESS") color=$GREEN ;;
        "ERROR")   color=$RED ;;
    esac

    # 1. Output a terminale (Solo se c'è un terminale reale, evita errori in background)
    if [[ -t 1 ]]; then
        echo -e "${color}${BOLD}[${level}]${NC} ${message}"
    fi

    # 2. Output su file (Sempre efficace, pulito per il debug)
    echo "[$timestamp] [$level] $message" >> "$LOG_FILE" 2>/dev/null || true
    logger -t SteamMachine-DIY "[$level] $message"
}

# --- Logic ---
case "$TARGET_MODE" in
    "steam"|"gamescope")
        SESSION="steamos-switcher"
        ;;
    "plasma"|"desktop")
        SESSION="plasma"
        if pgrep -u "$CURRENT_USER" -x "steam" > /dev/null; then
            log_message "INFO" "Steam detected. Sending shutdown signal..."
            sudo -u "$CURRENT_USER" steam -shutdown || true
            sleep 1
        fi
        ;;
    *)
        echo -e "${RED}Error:${NC} Usage: $0 {steam|desktop}"
        exit 1
        ;;
esac

# --- Execution ---
log_message "EXEC" "Switching session to: ${BOLD}$SESSION${NC}"

if sudo "$HELPER_PATH" "$SESSION" "$CURRENT_USER"; then
    log_message "SUCCESS" "Handover complete. Terminating session..."
    # Piccola nota: qui non serve sleep, vogliamo velocità!
    exec loginctl terminate-user "$CURRENT_USER"
else
    log_message "ERROR" "Helper failed to update SDDM state."
    exit 1
fi
