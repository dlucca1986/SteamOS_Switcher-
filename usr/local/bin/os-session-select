#!/bin/bash
# ==============================================================================
# SteamOS / Plasma Session Switcher
# Logic handler for seamless transitions and cloud sync preservation.
# ==============================================================================

# Silent redirection to log file for background troubleshooting
LOG_FILE="/tmp/os-session-select.log"
exec > "$LOG_FILE" 2>&1

SESSION_INPUT=${1:-"steam"}
USER_NAME=$(id -un)

case "$SESSION_INPUT" in
    "plasma"|"desktop")
        SESSION_FILE="plasma" 
        pkill -u "$USER_NAME" -TERM steam 2>/dev/null
        sleep 1
        steam -shutdown &>/dev/null || true
        ;;

    "gamescope-session-steam"|"steam"|"gaming"|"steamos")
        SESSION_FILE="steamos-switcher"
        ;;

    *)
        exit 1
        ;;
esac

# Update SDDM configuration via the privileged helper script
sudo /usr/local/bin/set-sddm-session "$SESSION_FILE" "$USER_NAME"

# Check execution status and terminate session
if [ $? -eq 0 ]; then
    sync
    loginctl terminate-user "$USER_NAME"
else
    exit 1
fi
