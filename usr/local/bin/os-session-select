#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Session Manager (os-session-select)
# =============================================================================
# Version: 3.0.0
# Description: Professional session switcher with integrated logging.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/os-session-select
# License: MIT
# =============================================================================

set -eou pipefail

# 1. VARIABLES
# Log located in /var/log. Note: Installer must create it and set chmod 666
readonly LOG_FILE="/var/log/steamos-diy.log"
readonly HELPER_BIN="/usr/local/bin/set-sddm-session"
readonly TARGET_MODE="${1:-}"
readonly CURRENT_USER="${SUDO_USER:-$(id -u -n)}"

# 2. LOGGING FUNCTION (Standardized)
log_msg() {
    local level="$1"
    local msg="$2"
    # Write to log. Use || true to prevent script blocking on write failure
    echo "[$level] $(date '+%Y-%m-%d %H:%M:%S') - $msg" >> "$LOG_FILE" 2>/dev/null || true
}

# 3. LOG ROTATION (Master Branch - Keep it light)
if [ -f "$LOG_FILE" ]; then
    LINES=$(wc -l < "$LOG_FILE" 2>/dev/null || echo 0)
    if [ "$LINES" -gt 1000 ]; then
        # sed -i requires write permissions on /var/log or the file itself
        sed -i '1,800d' "$LOG_FILE" 2>/dev/null || true
        log_msg "INFO" "Log rotated to maintain performance"
    fi
fi

echo "================================" >> "$LOG_FILE" 2>/dev/null || true

# 4. INPUT VALIDATION
case "${TARGET_MODE,,}" in
    "steam"|"gamescope"|"steamos")
        SESSION="steamos-switcher"
        ;;
    "plasma"|"desktop"|"kde"|"default")
        SESSION="plasma"
        ;;
    *)
        log_msg "ERROR" "Invalid mode requested: $TARGET_MODE"
        echo "Usage: os-session-select [steam|plasma]"
        exit 1
        ;;
esac

log_msg "INFO" "Switch initiated by $CURRENT_USER to $SESSION"

# 5. EXECUTE PRIVILEGED HELPER
# Pass current user and log path so the helper remains context-aware
if ! sudo "$HELPER_BIN" "$SESSION" "$CURRENT_USER" "$LOG_FILE"; then
    log_msg "ERROR" "Failed to initiate session switch via $HELPER_BIN"
    exit 1
fi

log_msg "SUCCESS" "Handover to helper completed"

sync
exit 0
