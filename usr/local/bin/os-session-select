#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Session Manager (os-session-select)
# =============================================================================
# Version: 2.3.0
# Description: Professional session switcher with ANSI styling.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/os-session-select
# License: MIT
# =============================================================================


set -eou pipefail

# --- Configuration ---
readonly HELPER_BIN="/usr/local/bin/set-sddm-session"
readonly LOG_FILE="/tmp/steamos-diy.log"
readonly TARGET_MODE="${1:-}"

# Detect real user even if running under sudo
readonly CURRENT_USER="${SUDO_USER:-$(id -u -n)}"

# --- UI Styling ---
BOLD='\033[1m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

# --- Functions ---
log_info() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${CYAN}${BOLD}[INFO]${NC} $1"
    echo "[$timestamp] [SUCCESS] $1" >> "$LOG_FILE" 2>/dev/null || true
}

log_error() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${RED}${BOLD}[ERROR]${NC} $1" >&2
    echo "[$timestamp] [ERROR] $1" >> "$LOG_FILE" 2>/dev/null || true
}

# --- Validation ---
if [[ -z "$TARGET_MODE" ]]; then
    echo -e "${BOLD}Usage:${NC} os-session-select {steam|plasma}"
    exit 1
fi

# --- Logic ---
case "${TARGET_MODE,,}" in
    "steam"|"gamescope")
        SESSION="steamos-switcher"
        ;;
    "plasma"|"desktop")
        SESSION="plasma"
        # Optional: Trigger Steam Cloud Sync before exit
        if pgrep -u "$CURRENT_USER" -x "steam" > /dev/null; then
            log_info "Initiating Steam shutdown (Cloud Sync)..."
            # Detached execution to prevent Steam from killing this script
            (sudo -u "$CURRENT_USER" steam -shutdown &) >/dev/null 2>&1
            sleep 1
        fi
        ;;
    *)
        log_error "Invalid target mode: $TARGET_MODE"
        exit 1
        ;;
esac

log_info "Switching to ${GREEN}${SESSION}${NC} for user ${GREEN}${CURRENT_USER}${NC}..."

# 1. Update SDDM state via Privileged Helper
# Using 'sudo -n' ensures it fails gracefully if sudoers is not configured
if ! sudo -n "$HELPER_BIN" "$SESSION" "$CURRENT_USER"; then
    log_error "Privileged helper failed. Check /etc/sudoers.d/ permissions."
    exit 1
fi

# 2. Final Handover
log_info "Handover successful. Terminating user session..."
exec loginctl terminate-user "$CURRENT_USER"
