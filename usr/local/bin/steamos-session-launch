#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Intelligent Universal Launcher
# =============================================================================
# Version: 3.0.0
# Description: Fail-safe launcher with HDR, VRR, and Mangoapp support.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/steamos-session-launch
# License: MIT
# =============================================================================

set -eou pipefail

# --- 1. Path Configuration ---
readonly LOG_FILE="/var/log/steamos-diy.log"
readonly CONFIG_FILE="$HOME/.config/steamos-diy/config"

# Logging Function: Writes to file and ensures open permissions for the UI/Control Center
log_msg() {
    local level="$1"
    local msg="$2"
    echo "[$level] $(date '+%Y-%m-%d %H:%M:%S') - $msg" >> "$LOG_FILE" 2>/dev/null || true
    chmod 666 "$LOG_FILE" 2>/dev/null || true
}

# Hardware Diagnostics: Logged on crash to help troubleshoot DRM/GPU issues
trace_gpu_failure() {
    log_msg "DEBUG" "--- GPU FAILURE DIAGNOSTIC ---"
    log_msg "DEBUG" "DRM Master Status: $(ls /sys/class/drm/card*/device/drm/card*/master 2>/dev/null || echo 'None found')"
    log_msg "DEBUG" "Processes using GPU: $(fuser -v /dev/dri/card* 2>&1 || echo 'None')"
}

# --- 2. Modes & Flags Initialization ---
SAFE_MODE=false
[[ "${1:-}" == "--safe-mode" ]] && SAFE_MODE=true

# Reset variables to empty (Empty values = Gamescope Auto-Negotiation)
W=""; H=""; R=""; HDR=0; VRR=0; MANGO=0

# --- 3. Configuration Logic ---
if [ "$SAFE_MODE" = true ]; then
    log_msg "ERROR" "!! SAFE MODE ACTIVE !! - Bypassing config and using -autoconfig"
    trace_gpu_failure
else
    if [[ -f "$CONFIG_FILE" ]]; then
        # Standard load from the configuration file provided by the installer/UI
        source "$CONFIG_FILE" 2>/dev/null || true
        W=${TARGET_WIDTH:-}
        H=${TARGET_HEIGHT:-}
        R=${REFRESH_RATE:-}
        HDR=${ENABLE_HDR:-0}
        VRR=${ENABLE_VRR:-0}
        MANGO=${ENABLE_MANGOAPP:-0}
        log_msg "INFO" "Configuration loaded from $CONFIG_FILE"
    else
        log_msg "WARN" "Config file not found. Proceeding with AUTO settings."
    fi
fi

# --- 4. Building Arguments ---
# -e: Required for Steam integration
G_ARGS=("-e")

# Apply user-defined parameters only if not in Safe Mode
if [ "$SAFE_MODE" = false ]; then
    [[ -n "$W" && -n "$H" ]] && G_ARGS+=("-W" "$W" "-H" "$H")
    [[ -n "$R" ]] && G_ARGS+=("-r" "$R")
    [[ "$HDR" == "1" ]] && G_ARGS+=("--hdr-enabled")
    [[ "$VRR" == "1" ]] && G_ARGS+=("--adaptive-sync")
    [[ "$MANGO" == "1" ]] && G_ARGS+=("--mangoapp")
fi

# --- 5. Session Start ---
log_msg "INFO" "-----------------------------------------------"
log_msg "INFO" " SESSION: $([ "$SAFE_MODE" = true ] && echo "!! SAFE MODE !!" || echo "USER OPTIMIZED")"
log_msg "INFO" " RENDER: ${W:-AUTO}x${H:-AUTO} @ ${R:-AUTO}Hz"
log_msg "INFO" " FLAGS: HDR:$HDR VRR:$VRR MANGO:$MANGO"
log_msg "INFO" "-----------------------------------------------"

START=$(date +%s)

# Execute Steam inside Gamescope
# -steamdeck -steamos3: Forces the Handheld UI
# -autoconfig: Only added during Safe Mode to reset corrupted internal video settings
stdbuf -oL -eL gamescope "${G_ARGS[@]}" -- \
    steam -steamdeck -steamos3 \
    $([ "$SAFE_MODE" = true ] && echo "-autoconfig") >> "$LOG_FILE" 2>&1 || true

# --- 6. Watchdog & Recovery ---
# Ensure the log file permissions remain accessible after session end/crash
chmod 666 "$LOG_FILE" 2>/dev/null || true

# Watchdog: If the session crashes in less than 2 seconds, trigger Safe Mode recovery
if [ "$SAFE_MODE" = false ] && [ $(( $(date +%s) - START )) -lt 2 ]; then
    log_msg "CRITICAL" "Session lasted < 2s. Crash detected."
    trace_gpu_failure
    log_msg "RECOVERY" "Re-executing in Safe Mode: exec $0 --safe-mode"
    exec "$0" --safe-mode
fi

log_msg "SUCCESS" "Session terminated gracefully"
exit 0
