#!/bin/bash
# =============================================================================
# SteamOs_Switcher - Gamescope Session Launcher
# =============================================================================
# Script: steamos-session-launch
# Description: Orchestrates the Gamescope compositor with optimized 
#              parameters for HDR, VRR, and Frame-pacing. 
#              Launches Steam in Gamepad UI mode (SteamOS 3 emulation).
# Path:        /usr/local/bin/steamos-session-launch
# =============================================================================

# --- User Configuration ---
readonly TARGET_WIDTH=1920
readonly TARGET_HEIGHT=1080
readonly REFRESH_RATE=120

# Features (1=Enabled, 0=Disabled)
readonly ENABLE_HDR=1
readonly ENABLE_VRR=1
readonly ENABLE_MANGOAPP=1

# --- Environment & Logging ---
readonly LOG_FILE="/tmp/gamescope-session.log"
exec > "$LOG_FILE" 2>&1

# Toolkit & Session Identity
export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=gamescope
export GAMEMODE_AUTO=1

# SteamOS Specific overrides
export STEAM_USE_MANGOAPP=1
export STEAM_MULTIPLE_XWAYLANDS=1

# --- Logic Functions ---

build_args() {
    # Base arguments: Physical output signal and refresh rate
    ARGS=(
        --output-width "$TARGET_WIDTH"
        --output-height "$TARGET_HEIGHT"
        --refresh "$REFRESH_RATE"
        --always-epl      # Ensures proper window focus for Steam overlays
        --hide-cursor-delay 3000
    )

    # Performance & Visual Features
    [[ $ENABLE_HDR -eq 1 ]]      && ARGS+=(--hdr-enabled)
    [[ $ENABLE_VRR -eq 1 ]]      && ARGS+=(--adaptive-sync)
    [[ $ENABLE_MANGOAPP -eq 1 ]] && ARGS+=(--mangoapp)

    echo "${ARGS[@]}"
}

# --- Execution ---

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting Gamescope Session..."
echo "Configuration: ${TARGET_WIDTH}x${TARGET_HEIGHT}@${REFRESH_RATE}Hz"

# Fetch constructed arguments
read -a FINAL_ARGS <<< "$(build_args)"

# Final launch command
# -e: Enables Steam Deck interface integration
# -steamos3: Unlocks SteamOS specific menus and features in the UI
exec gamescope "${FINAL_ARGS[@]}" -e -- \
    steam -steamdeck -steamos -steamos3
